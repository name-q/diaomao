# AI代码审查项目 - 基于Egg.js

## 项目概述

这是一个基于 Egg.js 框架开发的 AI 代码审查服务，实现了以下核心功能：

### ✅ 已实现功能

1. **AI代码审查**
   - 支持多个AI提供商：OpenAI、DeepSeek、通义千问
   - 智能代码diff分析和审查
   - 可配置的审查风格和Token限制

2. **企业微信通知**
   - 支持不同项目配置不同的企业微信群
   - 自动分割长消息避免超出限制
   - Markdown格式的审查报告

3. **多平台支持**
   - GitHub Webhook（Pull Request、Push事件）
   - GitLab Webhook（Merge Request、Push事件）
   - 异步处理，快速响应

## 项目结构

```
ai-codereview/
├── app/
│   ├── controller/
│   │   └── webhook.js          # Webhook控制器
│   ├── service/
│   │   ├── ai.js              # AI服务
│   │   ├── review.js          # 代码审查服务
│   │   └── wecom.js           # 企业微信通知服务
│   └── router.js              # 路由配置
├── config/
│   ├── config.default.js      # 应用配置
│   └── plugin.js              # 插件配置
├── test/                      # 测试文件
├── .env.example              # 环境变量示例
├── Dockerfile                # Docker配置
├── docker-compose.yml        # Docker Compose配置
└── README.md                 # 项目文档
```

## 核心特性

### 🤖 AI集成
- **多提供商支持**：可在OpenAI、DeepSeek、通义千问之间切换
- **智能截断**：使用tiktoken精确计算Token数量，避免超出限制
- **专业审查**：基于代码质量、编码规范、架构设计等维度进行审查

### 📱 企业微信集成
- **项目级配置**：不同项目可配置不同的企业微信群
- **消息分割**：自动处理超长消息，分批发送
- **格式优化**：支持Markdown格式，提供清晰的审查报告

### 🔗 Git平台集成
- **GitHub支持**：处理Pull Request和Push事件
- **GitLab支持**：处理Merge Request和Push事件
- **异步处理**：快速响应Webhook，后台异步处理审查

## 配置说明

### 环境变量配置

```bash
# AI配置
LLM_PROVIDER=openai
OPENAI_API_KEY=your_key
REVIEW_MAX_TOKENS=10000

# 企业微信配置
WECOM_ENABLED=1
WECOM_WEBHOOK_URL=your_webhook_url

# 不同项目的企业微信配置
WECOM_WEBHOOK_URL_PROJECT1=project1_webhook_url
WECOM_WEBHOOK_URL_PROJECT2=project2_webhook_url

# Git平台配置
GITHUB_ACCESS_TOKEN=your_github_token
GITLAB_ACCESS_TOKEN=your_gitlab_token
```

## 部署方式

### 1. 直接部署
```bash
npm install
npm start
```

### 2. Docker部署
```bash
docker-compose up -d
```

### 3. PM2部署
```bash
pm2 start npm --name "ai-codereview" -- start
```

## 使用方法

1. **配置环境变量**：复制 `.env.example` 为 `.env` 并填写配置
2. **启动服务**：运行 `npm start`
3. **配置Webhook**：在GitHub/GitLab项目中配置Webhook指向 `http://your-domain/webhook`
4. **测试功能**：创建PR或推送代码，查看企业微信群中的审查报告

## 与参考项目的对比

| 功能 | Python项目 | Egg.js项目 | 说明 |
|------|------------|------------|------|
| AI代码审查 | ✅ | ✅ | 核心功能完全实现 |
| 企业微信通知 | ✅ | ✅ | 支持多项目配置 |
| GitHub支持 | ✅ | ✅ | PR和Push事件 |
| GitLab支持 | ✅ | ✅ | MR和Push事件 |

## 技术栈

- **框架**：Egg.js 3.x
- **HTTP客户端**：Axios
- **Token计算**：tiktoken
- **配置管理**：环境变量
- **测试框架**：Mocha + egg-mock
- **代码规范**：ESLint

## 注意事项

1. 确保服务器能访问配置的AI服务API
2. 企业微信机器人需要先创建并获取Webhook URL
3. GitHub/GitLab访问令牌需要相应权限
4. 建议生产环境使用HTTPS
5. 代码内容会根据最大Token数进行截断

专注于AI代码审查和企业微信通知，代码简洁高效，易于部署和维护。